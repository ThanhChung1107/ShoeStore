{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block content %}
<div class="container">
        <div class="main-content">
            <!-- Sidebar với bộ lọc -->
            <div class="sidebar">
                <h3><i class="fas fa-filter"></i> Bộ Lọc Sản Phẩm</h3>
                
                <!-- Lọc theo danh mục -->
                <div class="filter-section">
                    <h4>Danh Mục</h4>
                    <label class="filter-option">
                    <input type="checkbox" name="category" value="all" {% if not current_category %}checked{% endif %}>
                    <span>Tất cả</span>
                </label>
                    {%for category in categories%}
                    <div class="filter-options">
                        <label class="filter-option">
                            <input type="checkbox" name="category" value="{{ category.id }}" 
                                {% if current_category == category.id|stringformat:"s" %}checked{% endif %}>
                            <span>{{ category.name }}</span>
                        </label>
                    </div>
                    {%endfor%}
                </div>

                <!-- Lọc theo thương hiệu -->
                <div class="filter-section">
                    <h4>Thương Hiệu</h4>
                    {%for brand in brands%}
                    <div class="filter-options">
                        <label class="filter-option">
                            <input type="checkbox" name="brand" value="{{ brand.id }}" 
                                {% if current_brand == brand.id|stringformat:"s" %}checked{% endif %}>
                            <span>{{ brand.name }}</span>
                        </label>
                    </div>
                    {%endfor%}
                </div>

                <!-- Lọc theo giá -->
                <div class="filter-section">
                    <h4>Khoảng Giá ( nghìn đồng )</h4>
                    <div class="filter-options">
                        <label class="filter-option">
                            <input type="checkbox" name="price" value="0-300000" {% if current_price_range == '0-300000' %}checked{% endif %}>
                            <span>Dưới 300</span>
                        </label>
                        <label class="filter-option">
                            <input type="checkbox" name="price" value="300000-500000" {% if current_price_range == '300000-500000' %}checked{% endif %}>
                            <span>300-500</span>
                        </label>
                        <label class="filter-option">
                            <input type="checkbox" name="price" value="500000-800000" {% if current_price_range == '500000-800000' %}checked{% endif %}>
                            <span>500-800</span>
                        </label>
                        <label class="filter-option">
                            <input type="checkbox" name="price" value="800000-99999999" {% if current_price_range == '800000-99999999' %}checked{% endif %}>
                            <span>trên 800</span>
                        </label>
                    </div>
                    <div class="price-range">
                        <div class="price-inputs">
                            <input type="number" id="minPrice" placeholder="Từ" min="0">
                            <input type="number" id="maxPrice" placeholder="Đến" min="0">
                            <button onclick="applyPriceRange()" class="accept-filters">Áp dụng</button>
                        </div>
                    </div>
                </div>

                <button class="clear-filters" onclick="clearAllFilters()">
                    <i class="fas fa-times"></i> Xóa Tất Cả Bộ Lọc
                </button>
            </div>

            <!-- Phần sản phẩm -->
            <div class="products-section">
                <div class="products-header">
                    <div>
                        <h2>Tất Cả Sản Phẩm</h2>
                        <div class="results-count">Hiển thị 12 trong tổng số {{total_products}} sản phẩm</div>
                    </div>
                    <select class="sort-select" onchange="sortProducts(this.value)">
                        <option value="default">Sắp xếp mặc định</option>
                        <option value="price-low">Giá: Thấp đến Cao</option>
                        <option value="price-high">Giá: Cao đến Thấp</option>
                        <option value="newest">Mới nhất</option>
                    </select>
                </div>
                
                <div class="products-grid" id="productsGrid">
                    <!-- Hàng 1 -->
                     {% for product in products %}
                    <a href="{% url 'product_detail' product.id %}" class="product-link">
                        <div class="product-card" data-category="shoes" data-price="{{ product.price }}" data-rating="{{ product.rating }}" data-color="mixed">
                            <img src="{{ product.image.url }}" alt="{{ product.name }}">
                            <h4 class="product-name">{{ product.name }}</h4>
                            <div class="brand">
                                {% if product.brand %}
                                <span class="brand-tag">{{ product.brand.name }}</span>
                                {% endif %}
                            </div>
                            <p>{{ product.price|intcomma }}₫</p>
                        </div>
                    </a>
                    {% endfor %}
                </div>
                

                <!-- Phân trang -->
                <div class="pagination">
                    {% if products.has_previous %}
                        <a href="?page={{ products.previous_page_number }}{% if current_category %}&category={{ current_category }}{% endif %}{% if current_brand %}&brand={{ current_brand }}{% endif %}{% if current_price_range %}&price={{ current_price_range }}{% endif %}{% if current_sort %}&sort={{ current_sort }}{% endif %}">&laquo;</a>
                    {% endif %}
                    
                    {% for i in products.paginator.page_range %}
                        <a href="?page={{ i }}{% if current_category %}&category={{ current_category }}{% endif %}{% if current_brand %}&brand={{ current_brand }}{% endif %}{% if current_price_range %}&price={{ current_price_range }}{% endif %}{% if current_sort %}&sort={{ current_sort }}{% endif %}" 
                        {% if products.number == i %}class="active"{% endif %}>{{ i }}</a>
                    {% endfor %}
                    
                    {% if products.has_next %}
                        <a href="?page={{ products.next_page_number }}{% if current_category %}&category={{ current_category }}{% endif %}{% if current_brand %}&brand={{ current_brand }}{% endif %}{% if current_price_range %}&price={{ current_price_range }}{% endif %}{% if current_sort %}&sort={{ current_sort }}{% endif %}">&raquo;</a>
                    {% endif %}
                </div>
            </div>
        </div>
</div>

{% comment %} JavaScript xử lý bộ lọc {% endcomment %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Khởi tạo
    initializeFilters();
});

function initializeFilters() {
    // Gắn sự kiện cho tất cả checkbox
    const checkboxes = document.querySelectorAll('.sidebar input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function(e) {
            e.preventDefault(); // Ngăn chặn hành vi mặc định
            applyFiltersAjax(); // Gọi hàm AJAX thay vì reload
        });
    });

    // Gắn sự kiện cho price inputs
    const priceInputs = document.querySelectorAll('.price-inputs input');
    priceInputs.forEach(input => {
        input.addEventListener('input', debounce(applyFiltersAjax, 500));
    });
}

// Hàm AJAX filtering (không reload trang)
function applyFiltersAjax() {
    // Thu thập dữ liệu filter
    const categories = [];
    const brands = [];
    const priceRanges = [];

    // Lấy categories đã chọn
    document.querySelectorAll('input[name="category"]:checked').forEach(cb => {
        if (cb.value !== 'all') {
            categories.push(cb.value);
        }
    });

    // Lấy brands đã chọn
    document.querySelectorAll('input[name="brand"]:checked').forEach(cb => {
        if (cb.value !== 'all') {
            brands.push(cb.value);
        }
    });

    // Lấy price ranges đã chọn
    document.querySelectorAll('input[name="price"]:checked').forEach(cb => {
        priceRanges.push(cb.value);
    });

    // Lấy giá min/max từ input
    const minPrice = document.getElementById('minPrice').value;
    const maxPrice = document.getElementById('maxPrice').value;

    // Tạo URL parameters
    const params = new URLSearchParams();
    
    if (categories.length > 0) {
        categories.forEach(cat => params.append('categories[]', cat));
    }
    
    if (brands.length > 0) {
        brands.forEach(brand => params.append('brands[]', brand));
    }
    
    if (priceRanges.length > 0) {
        params.append('price_range', priceRanges[0]);
    }
    
    if (minPrice) params.append('min_price', minPrice);
    if (maxPrice) params.append('max_price', maxPrice);

    // Gọi AJAX request
    fetch(`{% url "filter_products" %}?${params.toString()}`, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        updateProductsDisplay(data);
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

function updateProductsDisplay(data) {
    const productsGrid = document.getElementById('productsGrid');
    const resultsCount = document.querySelector('.results-count');
    
    // Cập nhật số lượng kết quả
    resultsCount.textContent = `Hiển thị ${data.count} sản phẩm`;
    
    // Parse products data
    const products = JSON.parse(data.products);
    
    // Xóa sản phẩm cũ với animation
    productsGrid.style.opacity = '0.5';
    
    setTimeout(() => {
        productsGrid.innerHTML = '';
        
        // Thêm sản phẩm mới
        products.forEach((productData, index) => {
            const product = productData.fields;
            const productCard = createProductCard(product, productData.pk);
            productsGrid.appendChild(productCard);
            
            // Animation cho sản phẩm mới
            setTimeout(() => {
                productCard.style.opacity = '1';
                productCard.style.transform = 'translateY(0)';
            }, index * 100);
        });
        
        productsGrid.style.opacity = '1';
    }, 300);
}

function createProductCard(product, productId) {
    const card = document.createElement('div');
    card.className = 'product-card';
    card.style.opacity = '0';
    card.style.transform = 'translateY(20px)';
    card.style.transition = 'all 0.3s ease';

    card.innerHTML = `
        <a href="/products/product/${productId}/" class="product-link">
            <img src="${product.image}" alt="${product.name}">
            <h4 class="product-name">${product.name}</h4>
        </a>
        ${product.brand ? `<div class="brand"><span class="brand-tag">${product.brand_name || ''}</span></div>` : ''}
        <p>${parseInt(product.price).toLocaleString()}₫</p>
    `;

    return card;
}


// Hàm debounce để tránh gọi API quá nhiều lần
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Hàm áp dụng khoảng giá từ input
function applyPriceRange() {
    applyFiltersAjax();
}

// Hàm xóa tất cả bộ lọc
function clearAllFilters() {
    // Bỏ chọn tất cả checkbox
    document.querySelectorAll('.sidebar input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
    });
    
    // Chọn lại "Tất cả"
    const allCategoryCheckbox = document.querySelector('input[value="all"]');
    if (allCategoryCheckbox) {
        allCategoryCheckbox.checked = true;
    }
    
    // Xóa giá trị price inputs
    document.getElementById('minPrice').value = '';
    document.getElementById('maxPrice').value = '';
    
    // Áp dụng filter (sẽ hiển thị tất cả)
    applyFiltersAjax();
}

// Hàm sắp xếp sản phẩm
function sortProducts(sortType) {
    const params = new URLSearchParams(window.location.search);
    params.set('sort', sortType);
    
    fetch(`{% url "filter_products" %}?${params.toString()}`, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => response.json())
    .then(data => {
        updateProductsDisplay(data);
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

// Animation styles
const style = document.createElement('style');
style.textContent = `
    .product-card {
        transition: all 0.3s ease;
    }
    
    .products-grid {
        transition: opacity 0.3s ease;
    }
    
    .filter-option input[type="checkbox"] {
        cursor: pointer;
    }
    .accept-filters:hover {
        background: #e74c3c;
    }
`;
document.head.appendChild(style);
</script>

{% endblock %}