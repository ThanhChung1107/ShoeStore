{% extends "base.html" %}
{% load static %}
{% load humanize %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/product_review.css' %}">
{% endblock %}
{% block content %}
<div class="small-container single-product">
    <div class="row">
        <div class="col-2">
            <img src="{{ product.image.url }}" width="100%" id="productImg">
            
            <!-- Thumbnail images (nếu có nhiều ảnh) -->
            <div class="small-img-row">
                {% if product.image2 %}
                <div class="small-img-col">
                    <img src="{{ product.image2.url }}" width="100%" class="small-img">
                </div>
                {% endif %}
                {% if product.image3 %}
                <div class="small-img-col">
                    <img src="{{ product.image3.url }}" width="100%" class="small-img">
                </div>
                {% endif %}
                {% if product.image4 %}
                <div class="small-img-col">
                    <img src="{{ product.image4.url }}" width="100%" class="small-img">
                </div>
                {% endif %}
            </div>
        </div>
        
        <div class="col-2">
            <p>Home / {{ product.category.name }}</p>
            <h1>{{ product.name }}</h1>
            <h4>{{ product.price|intcomma }}₫</h4>
            
            <!-- Nút mở modal gợi ý size -->
            <div class="size-suggestion">
                <button type="button" class="btn-size-help" onclick="openSizeModal()">
                    <i class="fa fa-question-circle"></i> Không biết chọn size?
                </button>
            </div>
            
            {% comment %} action="{% url 'add_to_cart' %}" method="post" {% endcomment %}
            <form action="{% url 'add_to_cart' product.id %}" method="POST" id="add-to-cart-form">
                {% csrf_token %}
                <input type="hidden" name="product_id" value="{{ product.id }}">
                
                <div class="size-selection">
                    <div class="size-options">
                        {% for product_size in available_sizes %}
                        <input type="radio" 
                            id="size-{{ product_size.size.id }}" 
                            name="size" 
                            value="{{ product_size.size.id }}"
                            class="size-option" 
                            required>
                        <label for="size-{{ product_size.size.id }}" 
                            class="size-label {% if product_size.stock <= 0 %}out-of-stock{% endif %}"
                            title="Còn {{ product_size.stock }} sản phẩm">
                            {{ product_size.size.value }}
                            {% if product_size.stock <= 0 %}
                            <span class="stock-status">(Hết)</span>
                            {% endif %}
                        </label>
                        {% empty %}
                        <div class="no-sizes">Sản phẩm tạm thời hết hàng</div>
                        {% endfor %}
                    </div>
                    <input type="hidden" name="selected_size" id="selected_size" value="">
                </div>
                
                <input type="number" name="quantity" value="1" min="1">
                <button type="submit" class="btn-add">Thêm vào giỏ</button>
            </form>
            
            <h3>Product Details <i class="fa fa-indent"></i></h3>
            <br>
            <p>{{ product.description }}</p>
        </div>
    </div>
</div>

<!-- Related Products -->
<div class="small-container">
    <div class="row row-2">
        <h2>Related Products</h2>
        <a href="{% url 'product' %}?category={{ product.category.id }}"><p>View More</p></a>
    </div>
    
    <div class="row">
        {% for related in related_products %}
        <div class="col-4 product-item">
                <a href="{% url 'product_detail' related.id %}">
                    <img src="{{ related.image.url }}" alt="{{ related.name }}" class="product-image">
                    <h4 class="product-name">{{ product.name }}</h4>
                </a>
                <div class="product-meta">
                    <div class="product-brand">
                        {% if related.brand %}
                        <span class="brand-tag">{{ related.brand.name }}</span>
                        {% endif %}
                    </div>
                    <div class="product-price">{{ related.price|intcomma }}₫</div>
                    {% if related.old_price %}
                    <div class="product-old-price">{{ related.old_price|intcomma }}₫</div>
                    {% endif %}
                </div>
                {% if related.discount_percent %}
                <div class="product-badge">-{{ related.discount_percent }}%</div>
                {% endif %}
            </div>
        {% endfor %}
    </div>
</div>
<div id="cart-notification">
    <span id="notification-message"></span>
</div>

<!-- Modal Gợi ý Chọn Size -->
<div id="sizeModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeSizeModal()">&times;</span>
        <h3>Gợi ý Chọn Size</h3>
        <p class="modal-description">Nhập kích thước bàn chân để được gợi ý size phù hợp nhất.</p>
        
        <form id="sizeForm">
            <div class="form-group">
                <label for="footLength">Chiều dài bàn chân (cm):</label>
                <input type="number" id="footLength" name="footLength" step="0.1" min="10" max="35" required>
                <small>Đo từ gót chân đến đầu ngón chân dài nhất</small>
            </div>
            
            <div class="form-group">
                <label for="footWidth">Chiều rộng bàn chân (cm):</label>
                <input type="number" id="footWidth" name="footWidth" step="0.1" min="5" max="15" required>
                <small>Đo tại phần rộng nhất của bàn chân</small>
            </div>
            
            <div class="form-group">
                <label for="footType">Loại bàn chân:</label>
                <select id="footType" name="footType">
                    <option value="normal">Bình thường</option>
                    <option value="wide">Rộng</option>
                    <option value="narrow">Hẹp</option>
                </select>
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn-cancel" onclick="closeSizeModal()">Hủy</button>
                <button type="submit" class="btn-submit">Gợi ý Size</button>
            </div>
        </form>
        
        <div id="sizeResult" class="size-result" style="display: none;">
            <h4>Gợi ý Size:</h4>
            <div id="recommendedSize" class="recommended-size"></div>
            <div id="sizeExplanation" class="size-explanation"></div>
            <div class="result-actions">
                <button type="button" class="btn-apply" onclick="applyRecommendedSize()">Áp dụng Size này</button>
                <button type="button" class="btn-reset" onclick="resetSizeForm()">Nhập lại</button>
            </div>
        </div>
    </div>
</div>

<!-- Phần Đánh Giá Sản Phẩm -->
<div class="small-container product-reviews-section">
    <div class="reviews-header">
        <h2>Đánh Giá Sản Phẩm</h2>
        <div class="rating-summary">
            <div class="average-rating">
                <span class="rating-number">{{ average_rating|floatformat:1 }}</span>
                <div class="stars">
                    {% for i in "12345" %}
                    <span class="star {% if i <= product.get_average_rating|floatformat:0 %}filled{% endif %}">★</span>
                    {% endfor %}
                </div>
                <span class="total-reviews">{{ product.get_review_count }} đánh giá</span>
            </div>
        </div>
    </div>

    <!-- Nút viết đánh giá -->
    {% if user.is_authenticated and can_review %}
    <button class="btn-review" onclick="openReviewModal()">Viết Đánh Giá</button>
    {% elif user.is_authenticated and not can_review%}
    <div class="review-info">
        {% comment %} <p>Bạn đã đánh giá sản phẩm này rồi.</p> {% endcomment %}
    </div>
    {% else %}
    <div class="review-info">
        <p>Vui lòng <a href="{% url 'login' %}">đăng nhập</a> và mua sản phẩm để đánh giá.</p>
    </div>
    {% endif %}

    <!-- Danh sách đánh giá -->
    <div class="reviews-list">
        {% for review in product.reviews.all|slice:":5" %}
        <div class="review-item">
            <div class="review-header">
                <div class="user-info">
                    <img src="{{ review.user.avatar.url|default:'/static/images/default-avatar.png' }}" 
                         alt="{{ review.user.username }}" class="user-avatar">
                    <span class="user-name">{{ review.user.username }}</span>
                </div>
                <div class="review-rating">
                    
                    {% for i in "12345" %}
                        <span class="star {% if forloop.counter <= review.rating %}filled{% endif %}" 
                            style="color: {% if forloop.counter <= review.rating %}#ffc107{% else %}#ddd{% endif %};">
                            ★
                        </span>
                    {% endfor %}
                </div>

            </div>
            
            <div class="review-content">
                <p class="review-comment">{{ review.comment }}</p>
                
                {% if review.images.all %}
                <div class="review-images">
                    {% for image in review.images.all %}
                    <img src="{{ image.image.url }}" alt="Review image" class="review-image">
                    {% endfor %}
                </div>
                {% endif %}
                
                <div class="review-date">{{ review.created_at|date:"d/m/Y H:i" }}</div>
            </div>
            
            {% if review.shop_reply %}
            <div class="shop-reply">
                <div class="reply-header">
                    <span class="shop-name">Phản hồi từ shop</span>
                    <span class="reply-date">{{ review.replied_at|date:"d/m/Y H:i" }}</span>
                </div>
                <p class="reply-content">{{ review.shop_reply }}</p>
            </div>
            {% endif %}
        </div>
        {% empty %}
        <div class="no-reviews">
            <p>Chưa có đánh giá nào cho sản phẩm này.</p>
        </div>
        {% endfor %}
    </div>

    <!-- Nút xem thêm đánh giá -->
    {% if product.get_review_count > 5 %}
    <div class="view-more-reviews">
        <a href="{% url 'product_reviews' product.id %}" class="btn-view-more">Xem tất cả đánh giá</a>
    </div>
    {% endif %}
</div>
<!-- Modal Đánh Giá -->
<div id="reviewModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeReviewModal()">&times;</span>
        <h3>Đánh Giá Sản Phẩm</h3>
        
        <form id="reviewForm" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" name="product_id" value="{{ product.id }}">
            
            <div class="form-group">
                <label>Đánh giá của bạn:</label>
                <div class="rating-input">
                    {% for i in "12345" %}
                    <input type="radio" id="star{{ i }}" name="rating" value="{{ i }}" required>
                    <label for="star{{ i }}">★</label>
                    {% endfor %}
                </div>
            </div>
            
            <div class="form-group">
                <label for="comment">Nhận xét:</label>
                <textarea name="comment" id="comment" rows="4" required placeholder="Chia sẻ trải nghiệm của bạn về sản phẩm..."></textarea>
            </div>
            
            <div class="form-group">
                <label for="images">Ảnh đính kèm (tối đa 4 ảnh):</label>
                <input type="file" name="images" id="images" multiple accept="image/*">
                <div id="imagePreview"></div>
            </div>
            
            <button type="submit" class="btn-submit">Gửi Đánh Giá</button>
        </form>
    </div>
</div>

<style>
/* CSS cho modal gợi ý size */
.size-suggestion {
    margin-bottom: 15px;
}

.btn-size-help {
    background-color: #f0f8ff;
    color: #007bff;
    border: 1px solid #007bff;
    padding: 8px 15px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s;
}

.btn-size-help:hover {
    background-color: #e1f0ff;
}

.modal-description {
    margin-bottom: 20px;
    color: #666;
}

.size-result {
    margin-top: 20px;
    padding: 15px;
    background-color: #f9f9f9;
    border-radius: 5px;
}

.recommended-size {
    font-size: 24px;
    font-weight: bold;
    color: #28a745;
    margin: 10px 0;
}

.size-explanation {
    margin: 10px 0;
    color: #555;
}

.result-actions {
    margin-top: 15px;
    display: flex;
    gap: 10px;
}

.btn-apply {
    background-color: #28a745;
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 4px;
    cursor: pointer;
}

.btn-reset {
    background-color: #6c757d;
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 4px;
    cursor: pointer;
}

.form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 20px;
}

.btn-cancel {
    background-color: #6c757d;
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 4px;
    cursor: pointer;
}

/* Modal chung */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.4);
}

.modal-content {
    background-color: #fefefe;
    margin: 5% auto;
    padding: 20px;
    border-radius: 8px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    position: relative;
}

.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    line-height: 1;
}

.close:hover {
    color: #000;
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
}

.form-group input, .form-group select {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    box-sizing: border-box;
}

.form-group small {
    display: block;
    margin-top: 5px;
    color: #666;
    font-size: 12px;
}
</style>

<script>
// JavaScript để xử lý thay đổi ảnh khi click vào thumbnail
const productImg = document.getElementById("productImg");
const smallImg = document.getElementsByClassName("small-img");

for(let i = 0; i < smallImg.length; i++) {
    smallImg[i].onclick = function() {
        productImg.src = smallImg[i].src;
    }
}

// Xử lý chọn size
document.querySelectorAll('.size-option').forEach(radio => {
    radio.addEventListener('change', function() {
        document.getElementById('selected_size').value = this.value;
    });
});

// Modal gợi ý size
function openSizeModal() {
    document.getElementById('sizeModal').style.display = 'block';
    resetSizeForm();
}

function closeSizeModal() {
    document.getElementById('sizeModal').style.display = 'none';
}

function resetSizeForm() {
    document.getElementById('sizeForm').reset();
    document.getElementById('sizeResult').style.display = 'none';
    document.getElementById('sizeForm').style.display = 'block';
}

// Xử lý form gợi ý size
document.getElementById('sizeForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const footLength = parseFloat(document.getElementById('footLength').value);
    const footWidth = parseFloat(document.getElementById('footWidth').value);
    const footType = document.getElementById('footType').value;
    
    // Thuật toán đơn giản để gợi ý size
    // Trong thực tế, bạn có thể cần một bảng tra cứu phức tạp hơn
    let recommendedSize = calculateSize(footLength, footWidth, footType);
    
    // Hiển thị kết quả
    document.getElementById('recommendedSize').textContent = `Size ${recommendedSize.size}`;
    document.getElementById('sizeExplanation').textContent = recommendedSize.explanation;
    
    // Lưu size được gợi ý để sử dụng sau
    document.getElementById('sizeResult').setAttribute('data-recommended-size', recommendedSize.size);
    
    document.getElementById('sizeForm').style.display = 'none';
    document.getElementById('sizeResult').style.display = 'block';
});

function calculateSize(length, width, type) {
    // Bảng tra cứu size dựa trên chiều dài bàn chân
    const sizeChart = [
        { min: 20.0, max: 20.5, size: "35" },
        { min: 20.6, max: 21.0, size: "36" },
        { min: 21.1, max: 21.5, size: "37" },
        { min: 21.6, max: 22.0, size: "38" },
        { min: 22.1, max: 22.5, size: "39" },
        { min: 22.6, max: 23.0, size: "40" },
        { min: 23.1, max: 23.5, size: "41" },
        { min: 23.6, max: 24.0, size: "42" },
        { min: 24.1, max: 24.5, size: "43" },
        { min: 24.6, max: 25.0, size: "44" }
    ];
    
    // Tìm size dựa trên chiều dài
    let size = "38"; // Mặc định
    let found = false;
    let explanation = "";
    
    for (const item of sizeChart) {
        if (length >= item.min && length <= item.max) {
            size = item.size;
            explanation = `Dựa trên chiều dài bàn chân ${length}cm, chúng tôi đề xuất size ${size}.`;
            found = true;
            break;
        }
    }
    
    // Nếu không tìm thấy size phù hợp
    if (!found) {
        explanation = `Không có sản phẩm nào phù hợp với kích thước chân của bạn (${length}cm).`;
        return {
            size: null,
            explanation: explanation
        };
    }
    
    // Điều chỉnh dựa trên chiều rộng và loại bàn chân
    if (type === "wide" && width > 9.5) {
        explanation += " Với bàn chân rộng, bạn có thể cân nhắc chọn size lớn hơn.";
    } else if (type === "narrow" && width < 8.5) {
        explanation += " Với bàn chân hẹp, bạn có thể cân nhắc chọn size nhỏ hơn.";
    }
    
    return {
        size: size,
        explanation: explanation
    };
}

function applyRecommendedSize() {
    const recommendedSize = document.getElementById('sizeResult').getAttribute('data-recommended-size');
    
    // Tìm và chọn size được gợi ý
    const sizeOptions = document.querySelectorAll('.size-option');
    for (const option of sizeOptions) {
        const sizeLabel = document.querySelector(`label[for="${option.id}"]`);
        if (sizeLabel && sizeLabel.textContent.includes(recommendedSize)) {
            option.checked = true;
            document.getElementById('selected_size').value = option.value;
            
            // Cuộn đến phần chọn size
            document.querySelector('.size-selection').scrollIntoView({ behavior: 'smooth' });
            
            // Đóng modal
            closeSizeModal();
            
            // Thông báo
            showNotification(`Đã chọn size ${recommendedSize} theo gợi ý`, 'success');
            return;
        }
    }
    
    // Nếu không tìm thấy size được gợi ý
    showNotification(`Không tìm thấy size ${recommendedSize} trong danh sách có sẵn`, 'error');
}

document.getElementById('add-to-cart-form').addEventListener('submit', function(e) {
    e.preventDefault()
    // Kiểm tra xem đã chọn size chưa (nếu có size options)
    const sizeOptions = document.querySelectorAll('.size-option');
    if (sizeOptions.length > 0) {
        const selectedSize = document.querySelector('.size-option:checked');
        if (!selectedSize) {
            alert('Vui lòng chọn size!');
            return;
        }
        // Cập nhật hidden field
        document.getElementById('selected_size').value = selectedSize.value;
    }
    
    const form = this;
    const formData = new FormData(form);
    
    // Debug: kiểm tra dữ liệu gửi đi
    console.log('Quantity:', formData.get('quantity'));
    console.log('Size:', formData.get('size'));
    console.log('Selected Size:', formData.get('selected_size'));
    
    // Thêm header để xác định AJAX request
    const headers = {
        'X-Requested-With': 'XMLHttpRequest',
        'X-CSRFToken': formData.get('csrfmiddlewaretoken')
    };
    
    fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: headers
    })
    .then(response => response.json())
    .then(data => {
        // KIỂM TRA NẾU CẦN CHUYỂN HƯỚNG ĐẾN LOGIN
        if (data.redirect && data.login_required) {
            window.location.href = data.login_url;
            return;
        }
        
        if (data.success) {
            // Hiển thị thông báo
            showNotification(data.message);
            
            // Cập nhật số lượng giỏ hàng (nếu có)
            if (data.cart_count !== undefined) {
                updateCartCount(data.cart_count);
            }
        } else {
            showNotification(data.message || 'Có lỗi xảy ra!', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Có lỗi xảy ra!', 'error');
    });
});

function showNotification(message, type = 'success') {
    const notification = document.getElementById('cart-notification');
    const messageEl = document.getElementById('notification-message');

    messageEl.textContent = message;
    notification.style.backgroundColor = type === 'success' ? 'green' : 'red';

    // Hiện thông báo
    notification.classList.add('show');

    // Ẩn sau 3 giây
    setTimeout(() => {
        notification.classList.remove('show');
    }, 3000);
}

function updateCartCount(count) {
    // Cập nhật số lượng giỏ hàng trên giao diện
    const cartCountEl = document.querySelector('.cart-count');
    if (cartCountEl) {
        cartCountEl.textContent = count;
    }
}

// Modal đánh giá functionality
function openReviewModal() {
    document.getElementById('reviewModal').style.display = 'block';
}

function closeReviewModal() {
    document.getElementById('reviewModal').style.display = 'none';
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('reviewModal');
    const sizeModal = document.getElementById('sizeModal');
    if (event.target === modal) {
        closeReviewModal();
    }
    if (event.target === sizeModal) {
        closeSizeModal();
    }
}

// Image preview
document.getElementById('images').addEventListener('change', function(e) {
    const preview = document.getElementById('imagePreview');
    preview.innerHTML = '';
    
    const files = e.target.files;
    const maxFiles = 4;
    
    if (files.length > maxFiles) {
        alert(`Chỉ có thể tải lên tối đa ${maxFiles} ảnh`);
        this.value = '';
        return;
    }
    
    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        if (!file.type.match('image.*')) {
            alert('Chỉ được phép tải lên file ảnh');
            this.value = '';
            preview.innerHTML = '';
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.className = 'preview-image';
            preview.appendChild(img);
        }
        reader.readAsDataURL(file);
    }
});

// Form submission đánh giá
document.getElementById('reviewForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    fetch('{% url "add_review" product.id %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            closeReviewModal();
            location.reload();
        } else {
            alert(data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Có lỗi xảy ra, vui lòng thử lại');
    });
});

// Rating stars hover effect
const stars = document.querySelectorAll('.rating-input label');
stars.forEach((star, index) => {
    star.addEventListener('mouseenter', () => {
        for (let i = stars.length - 1; i >= index; i--) {
            stars[i].style.color = '#ffd700';
        }
    });
    
    star.addEventListener('mouseleave', () => {
        const checked = document.querySelector('.rating-input input:checked');
        if (checked) {
            const checkedIndex = parseInt(checked.value) - 1;
            for (let i = 4; i >= 0; i--) {
                stars[i].style.color = i <= checkedIndex ? '#ffd700' : '#ddd';
            }
        } else {
            stars.forEach(s => s.style.color = '#ddd');
        }
    });
});
</script>
{% endblock %}