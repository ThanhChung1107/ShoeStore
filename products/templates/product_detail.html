{% extends "base.html" %}
{% load static %}
{% load humanize %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/product_review.css' %}">
{% endblock %}
{% block content %}
<div class="small-container single-product">
    <div class="row">
        <div class="col-2">
            <img src="{{ product.image.url }}" width="100%" id="productImg">
            
            <!-- Thumbnail images (nếu có nhiều ảnh) -->
            <div class="small-img-row">
                {% if product.image2 %}
                <div class="small-img-col">
                    <img src="{{ product.image2.url }}" width="100%" class="small-img">
                </div>
                {% endif %}
                {% if product.image3 %}
                <div class="small-img-col">
                    <img src="{{ product.image3.url }}" width="100%" class="small-img">
                </div>
                {% endif %}
                {% if product.image4 %}
                <div class="small-img-col">
                    <img src="{{ product.image4.url }}" width="100%" class="small-img">
                </div>
                {% endif %}
            </div>
        </div>
        
        <div class="col-2">
            <p>Home / {{ product.category.name }}</p>
            <h1>{{ product.name }}</h1>
            <h4>{{ product.price|intcomma }}₫</h4>
            
            {% comment %} action="{% url 'add_to_cart' %}" method="post" {% endcomment %}
            <form action="{% url 'add_to_cart' product.id %}" method="POST" id="add-to-cart-form">
                {% csrf_token %}
                <input type="hidden" name="product_id" value="{{ product.id }}">
                
                <div class="size-selection">
                    <div class="size-options">
                        {% for product_size in available_sizes %}
                        <input type="radio" 
                            id="size-{{ product_size.size.id }}" 
                            name="size" 
                            value="{{ product_size.size.id }}"
                            class="size-option" 
                            required>
                        <label for="size-{{ product_size.size.id }}" 
                            class="size-label {% if product_size.stock <= 0 %}out-of-stock{% endif %}"
                            title="Còn {{ product_size.stock }} sản phẩm">
                            {{ product_size.size.value }}
                            {% if product_size.stock <= 0 %}
                            <span class="stock-status">(Hết)</span>
                            {% endif %}
                        </label>
                        {% empty %}
                        <div class="no-sizes">Sản phẩm tạm thời hết hàng</div>
                        {% endfor %}
                    </div>
                    <input type="hidden" name="selected_size" id="selected_size" value="">
                </div>
                
                <input type="number" name="quantity" value="1" min="1">
                <button type="submit" class="btn-add">Thêm vào giỏ</button>
            </form>
            
            <h3>Product Details <i class="fa fa-indent"></i></h3>
            <br>
            <p>{{ product.description }}</p>
        </div>
    </div>
</div>

<!-- Related Products -->
<div class="small-container">
    <div class="row row-2">
        <h2>Related Products</h2>
        <a href="{% url 'product' %}?category={{ product.category.id }}"><p>View More</p></a>
    </div>
    
    <div class="row">
        {% for related in related_products %}
        <div class="col-4 product-item">
                <a href="{% url 'product_detail' related.id %}">
                    <img src="{{ related.image.url }}" alt="{{ related.name }}" class="product-image">
                    <h4 class="product-name">{{ product.name }}</h4>
                </a>
                <div class="product-meta">
                    <div class="product-brand">
                        {% if related.brand %}
                        <span class="brand-tag">{{ related.brand.name }}</span>
                        {% endif %}
                    </div>
                    <div class="product-price">{{ related.price|intcomma }}₫</div>
                    {% if related.old_price %}
                    <div class="product-old-price">{{ related.old_price|intcomma }}₫</div>
                    {% endif %}
                </div>
                {% if related.discount_percent %}
                <div class="product-badge">-{{ related.discount_percent }}%</div>
                {% endif %}
            </div>
        {% endfor %}
    </div>
</div>
<div id="cart-notification">
    <span id="notification-message"></span>
</div>
<!-- Phần Đánh Giá Sản Phẩm -->
<div class="small-container product-reviews-section">
    <div class="reviews-header">
        <h2>Đánh Giá Sản Phẩm</h2>
        <div class="rating-summary">
            <div class="average-rating">
                <span class="rating-number">{{ average_rating|floatformat:1 }}</span>
                <div class="stars">
                    {% for i in "12345" %}
                    <span class="star {% if i <= product.get_average_rating|floatformat:0 %}filled{% endif %}">★</span>
                    {% endfor %}
                </div>
                <span class="total-reviews">{{ product.get_review_count }} đánh giá</span>
            </div>
        </div>
    </div>

    <!-- Nút viết đánh giá -->
    {% if user.is_authenticated and can_review %}
    <button class="btn-review" onclick="openReviewModal()">Viết Đánh Giá</button>
    {% elif user.is_authenticated and not can_review%}
    <div class="review-info">
        {% comment %} <p>Bạn đã đánh giá sản phẩm này rồi.</p> {% endcomment %}
    </div>
    {% else %}
    <div class="review-info">
        <p>Vui lòng <a href="{% url 'login' %}">đăng nhập</a> và mua sản phẩm để đánh giá.</p>
    </div>
    {% endif %}

    <!-- Danh sách đánh giá -->
    <div class="reviews-list">
        {% for review in product.reviews.all|slice:":5" %}
        <div class="review-item">
            <div class="review-header">
                <div class="user-info">
                    <img src="{{ review.user.avatar.url|default:'/static/images/default-avatar.png' }}" 
                         alt="{{ review.user.username }}" class="user-avatar">
                    <span class="user-name">{{ review.user.username }}</span>
                </div>
                <div class="review-rating">
                    
                    {% for i in "12345" %}
                        <span class="star {% if forloop.counter <= review.rating %}filled{% endif %}" 
                            style="color: {% if forloop.counter <= review.rating %}#ffc107{% else %}#ddd{% endif %};">
                            ★
                        </span>
                    {% endfor %}
                </div>

            </div>
            
            <div class="review-content">
                <p class="review-comment">{{ review.comment }}</p>
                
                {% if review.images.all %}
                <div class="review-images">
                    {% for image in review.images.all %}
                    <img src="{{ image.image.url }}" alt="Review image" class="review-image">
                    {% endfor %}
                </div>
                {% endif %}
                
                <div class="review-date">{{ review.created_at|date:"d/m/Y H:i" }}</div>
            </div>
            
            {% if review.shop_reply %}
            <div class="shop-reply">
                <div class="reply-header">
                    <span class="shop-name">Phản hồi từ shop</span>
                    <span class="reply-date">{{ review.replied_at|date:"d/m/Y H:i" }}</span>
                </div>
                <p class="reply-content">{{ review.shop_reply }}</p>
            </div>
            {% endif %}
        </div>
        {% empty %}
        <div class="no-reviews">
            <p>Chưa có đánh giá nào cho sản phẩm này.</p>
        </div>
        {% endfor %}
    </div>

    <!-- Nút xem thêm đánh giá -->
    {% if product.get_review_count > 5 %}
    <div class="view-more-reviews">
        <a href="{% url 'product_reviews' product.id %}" class="btn-view-more">Xem tất cả đánh giá</a>
    </div>
    {% endif %}
</div>
<!-- Modal Đánh Giá -->
<div id="reviewModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeReviewModal()">&times;</span>
        <h3>Đánh Giá Sản Phẩm</h3>
        
        <form id="reviewForm" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" name="product_id" value="{{ product.id }}">
            
            <div class="form-group">
                <label>Đánh giá của bạn:</label>
                <div class="rating-input">
                    {% for i in "12345" %}
                    <input type="radio" id="star{{ i }}" name="rating" value="{{ i }}" required>
                    <label for="star{{ i }}">★</label>
                    {% endfor %}
                </div>
            </div>
            
            <div class="form-group">
                <label for="comment">Nhận xét:</label>
                <textarea name="comment" id="comment" rows="4" required placeholder="Chia sẻ trải nghiệm của bạn về sản phẩm..."></textarea>
            </div>
            
            <div class="form-group">
                <label for="images">Ảnh đính kèm (tối đa 4 ảnh):</label>
                <input type="file" name="images" id="images" multiple accept="image/*">
                <div id="imagePreview"></div>
            </div>
            
            <button type="submit" class="btn-submit">Gửi Đánh Giá</button>
        </form>
    </div>
</div>
<script>
// JavaScript để xử lý thay đổi ảnh khi click vào thumbnail
const productImg = document.getElementById("productImg");
const smallImg = document.getElementsByClassName("small-img");

for(let i = 0; i < smallImg.length; i++) {
    smallImg[i].onclick = function() {
        productImg.src = smallImg[i].src;
    }
}

// Xử lý chọn size
document.querySelectorAll('.size-option').forEach(radio => {
    radio.addEventListener('change', function() {
        document.getElementById('selected_size').value = this.value;
    });
});

document.getElementById('add-to-cart-form').addEventListener('submit', function(e) {
    e.preventDefault()
    // Kiểm tra xem đã chọn size chưa (nếu có size options)
    const sizeOptions = document.querySelectorAll('.size-option');
    if (sizeOptions.length > 0) {
        const selectedSize = document.querySelector('.size-option:checked');
        if (!selectedSize) {
            alert('Vui lòng chọn size!');
            return;
        }
        // Cập nhật hidden field
        document.getElementById('selected_size').value = selectedSize.value;
    }
    
    const form = this;
    const formData = new FormData(form);
    
    // Debug: kiểm tra dữ liệu gửi đi
    console.log('Quantity:', formData.get('quantity'));
    console.log('Size:', formData.get('size'));
    console.log('Selected Size:', formData.get('selected_size'));
    
    // Thêm header để xác định AJAX request
    const headers = {
        'X-Requested-With': 'XMLHttpRequest',
        'X-CSRFToken': formData.get('csrfmiddlewaretoken')
    };
    
    fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: headers
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Hiển thị thông báo
            showNotification(data.message);
            
            // Cập nhật số lượng giỏ hàng (nếu có)
            if (data.cart_count !== undefined) {
                updateCartCount(data.cart_count);
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Có lỗi xảy ra!', 'error');
    });
});

function showNotification(message, type = 'success') {
    const notification = document.getElementById('cart-notification');
    const messageEl = document.getElementById('notification-message');

    messageEl.textContent = message;
    notification.style.backgroundColor = type === 'success' ? 'green' : 'red';

    // Hiện thông báo
    notification.classList.add('show');

    // Ẩn sau 3 giây
    setTimeout(() => {
        notification.classList.remove('show');
    }, 3000);
}

function updateCartCount(count) {
    // Cập nhật số lượng giỏ hàng trên giao diện
    const cartCountEl = document.querySelector('.cart-count');
    if (cartCountEl) {
        cartCountEl.textContent = count;
    }
}
// Modal functionality
function openReviewModal() {
    document.getElementById('reviewModal').style.display = 'block';
}

function closeReviewModal() {
    document.getElementById('reviewModal').style.display = 'none';
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('reviewModal');
    if (event.target === modal) {
        closeReviewModal();
    }
}

// Image preview
document.getElementById('images').addEventListener('change', function(e) {
    const preview = document.getElementById('imagePreview');
    preview.innerHTML = '';
    
    const files = e.target.files;
    const maxFiles = 4;
    
    if (files.length > maxFiles) {
        alert(`Chỉ có thể tải lên tối đa ${maxFiles} ảnh`);
        this.value = '';
        return;
    }
    
    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        if (!file.type.match('image.*')) {
            alert('Chỉ được phép tải lên file ảnh');
            this.value = '';
            preview.innerHTML = '';
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.className = 'preview-image';
            preview.appendChild(img);
        }
        reader.readAsDataURL(file);
    }
});

// Form submission
document.getElementById('reviewForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    fetch('{% url "add_review" product.id %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            closeReviewModal();
            location.reload();
        } else {
            alert(data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Có lỗi xảy ra, vui lòng thử lại');
    });
});

// Rating stars hover effect
const stars = document.querySelectorAll('.rating-input label');
stars.forEach((star, index) => {
    star.addEventListener('mouseenter', () => {
        for (let i = stars.length - 1; i >= index; i--) {
            stars[i].style.color = '#ffd700';
        }
    });
    
    star.addEventListener('mouseleave', () => {
        const checked = document.querySelector('.rating-input input:checked');
        if (checked) {
            const checkedIndex = parseInt(checked.value) - 1;
            for (let i = 4; i >= 0; i--) {
                stars[i].style.color = i <= checkedIndex ? '#ffd700' : '#ddd';
            }
        } else {
            stars.forEach(s => s.style.color = '#ddd');
        }
    });
});
</script>
{% endblock %}