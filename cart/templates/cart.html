{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="small-container cart-page">
    <table>
        <tr>
            <th>Select</th>
            <th>Product</th>
            <th>Quantity</th>
            <th>Subtotal</th>
        </tr>
        {% for item in cart.items.all %}
        <tr>
            <td>
                <input type="checkbox" class="item-check" data-price="{{ item.subtotal }}" checked>
            </td>
            <td>
                <div class="cart-info">
                    <img src="{{ item.product.image.url }}">
                    <div>
                        <p>{{ item.product.name }}</p>
                        <small>Giá: {{ item.product.price|floatformat:0 }}₫</small><br>
                        <a href="{% url 'remove_from_cart' item.id %}">Xóa</a>
                    </div>
                </div>
            </td>
            <td>
                <!-- Xóa form lồng, thay bằng link hoặc JavaScript -->
                
                <form method="post" action="{% url 'update_cart' item.id %}">
                    {% csrf_token %}
                    <input type="number" name="quantity" value="{{ item.quantity }}" min="1">
                    <button type="submit" class="btn-update">Cập nhật</button>
                </form>

            </td>
            <td>{{ item.subtotal|floatformat:0 }}₫</td>
        </tr>
        {% endfor %}
    </table>
    <div class="total-price">
        <table>
            <tr>
                <td>Subtotal</td>
                <td><span id="subtotal">0</span>₫</td>
            </tr>
            <tr>
                <td>Giảm giá</td>
                <td>--:--</td>
            </tr>
            <tr>
                <td>Total</td>
                <td><span id="total">0</span>₫</td>
            </tr>
        </table>
    </div>
    <form>
    {% csrf_token %}
    {% comment %} {% for item in cart.items.all %}
        <input type="hidden" name="selected_items" value="{{ item.id }}">
    {% endfor %} {% endcomment %}
    <div class="checkout-btn">
        <button type="submit" class="btn-cart">Thanh toán</button>
    </div>
</form>
</div>

<script>
    function formatCurrency(num) {
        return new Intl.NumberFormat('vi-VN').format(num);
    }

    function updateTotal() {
        let subtotal = 0;
        document.querySelectorAll('.item-check').forEach(cb => {
            if (cb.checked) {
                subtotal += parseInt(cb.dataset.price);
            }
        });

        // cập nhật HTML
        document.getElementById("subtotal").textContent = formatCurrency(subtotal);
        document.getElementById("total").textContent = formatCurrency(subtotal); // ở đây có thể + thuế, phí ship
    }

    // lắng nghe tick
    document.querySelectorAll('.item-check').forEach(cb => {
        cb.addEventListener('change', updateTotal);
    });

    // chạy 1 lần khi load
    updateTotal();
</script>

{%endblock%}