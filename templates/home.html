{% extends "base.html" %}
{% load static %}
{% load humanize %}
{% block content %}
<div class="row head-background">
    <div class="col-2">
        <h1>Give your Workout <br>A New Style!</h1>
        <p>Success isn't always about greatness. It's about consistency. Consistent<br>hard work gains success. Greatness will come.</p>
        <a href="{%url 'product'%}" class="btn">Explore Now &#8594;</a>
    </div>
    <div class="col-2">
        <img src="{%static 'image/image1.png'%}">
    </div>
</div>

        <div id="home" class="section">
            <div class="coverflow-wrapper">
                <div class="info">
                    <h2 id="current-title">Mountain Landscape</h2>
                    <p id="current-description">Majestic peaks covered in snow during golden hour</p>
                </div>

                <div class="coverflow-container" tabindex="0">
                    <div class="coverflow" id="coverflow">
                        <div class="coverflow-item" data-index="0">
                            <div class="cover image-loading">
                                <img src="{%static 'image/ronaldo.jpg'%}" alt="Mountain Landscape" loading="lazy">
                            </div>
                            <div class="reflection"></div>
                        </div>
                        <div class="coverflow-item" data-index="1">
                            <div class="cover image-loading">
                                <img src="{%static 'image/giay-cau-long.webp'%}" alt="Forest Path" loading="lazy">
                            </div>
                            <div class="reflection"></div>
                        </div>
                        <div class="coverflow-item" data-index="2">
                            <div class="cover image-loading">
                                <img src="{%static 'image/dep-messi.avif'%}" alt="Lake Reflection" loading="lazy">
                            </div>
                            <div class="reflection"></div>
                        </div>
                        <div class="coverflow-item" data-index="3">
                            <div class="cover image-loading">
                                <img src="{%static 'image/sneaker.jpg'%}" alt="Ocean Sunset" loading="lazy">
                            </div>
                            <div class="reflection"></div>
                        </div>
                        <div class="coverflow-item" data-index="4">
                            <div class="cover image-loading">
                                <img src="{%static 'image/giay_chay_bo.jpg'%}" alt="Desert Dunes" loading="lazy">
                            </div>
                            <div class="reflection"></div>
                        </div>
                        <div class="coverflow-item" data-index="5">
                            <div class="cover image-loading">
                                <img src="{%static 'image/giay-tay.webp'%}" alt="Starry Night" loading="lazy">
                            </div>
                            <div class="reflection"></div>
                        </div>
                        <div class="coverflow-item" data-index="6">
                            <div class="cover image-loading">
                                <img src="{%static 'image/sandals.webp'%}" alt="Waterfall" loading="lazy">
                            </div>
                            <div class="reflection"></div>
                        </div>
                    </div>

                    <button class="nav-button prev" onclick="navigate(-1)">‹</button>
                    <button class="nav-button next" onclick="navigate(1)">›</button>

                    <div class="dots-container" id="dots"></div>
                    
                    <!-- Play/Pause Button -->
                    <button class="play-pause-button" id="playPauseBtn" onclick="toggleAutoplay()">
                        <span class="play-icon">▶</span>
                        <span class="pause-icon" style="display: none;">❚❚</span>
                    </button>
                </div>
            </div>
        </div>


        <!------------------------------ featured Products------------------------------>
    <div class="small-container">
        <!-- Sản phẩm nổi bật -->
        <h2 class="title">Sản phẩm nổi bật</h2>
        <!-- Phần sản phẩm đề xuất -->
        <section class="recommended-products">
            <div class="container">
                <div class="row" id="recommendedProducts">
                    <!-- Sẽ được load bằng AJAX -->
                    <div class="loading">Đang tải đề xuất...</div>
                </div>
            </div>
        </section>

        <script>
            document.addEventListener('DOMContentLoaded', function() {
                loadRecommendations();
            });

            function loadRecommendations() {
                fetch('/products/recommendations/?limit=8')
                    .then(response => response.json())
                    .then(data => {
                        const container = document.getElementById('recommendedProducts');
                        
                        if (data.recommendations && data.recommendations.length > 0) {
                            container.innerHTML = '';
                            
                            data.recommendations.forEach(product => {
                                const productUrl = `/products/product/${product.id}/`;
                                const brandName = product.brand ? `<span class="brand-tag">${product.brand}</span>` : '';
                                const productCard = `
                                    <div class="col-4 product-item">
                                        <a href="${productUrl}">
                                            <img src="${product.image}" alt="${product.name}" class="product-image">
                                            <h4 class="product-name">${product.name}</h4>
                                        </a>
                                        <div class="product-meta">
                                            <div class="product-brand">${brandName}</div>
                                            <div class="product-price">${Number(product.price).toLocaleString()}₫</div>
                                        </div>
                                    </div>
                                `;
                                container.innerHTML += productCard;
                            });
                            
                            // Tracking click
                            container.querySelectorAll('.product-item a').forEach(link => {
                                link.addEventListener('click', function() {
                                    const productId = this.href.split('/').slice(-2, -1)[0]; // lấy id từ URL
                                    trackProductView(productId);
                                });
                            });
                            
                        } else {
                            container.innerHTML = '<p>Không có đề xuất nào vào lúc này.</p>';
                        }
                    })
                    .catch(error => {
                        console.error('Error loading recommendations:', error);
                        document.getElementById('recommendedProducts').innerHTML = 
                            '<p>Không thể tải đề xuất.</p>';
                    });
            }
            </script>


        <!-- Sản phẩm mới nhất -->
        <h2 class="title">Sản phẩm mới nhất</h2>
        <div class="row">
            {% for product in latest_products %}
            <div class="col-4 product-item">
                <a href="{% url 'product_detail' product.id %}">
                    <img src="{{ product.image.url }}" alt="{{ product.name }}" class="product-image">
                    <h4 class="product-name">{{ product.name }}</h4>
                </a>
                <div class="product-meta">
                    <div class="product-brand">
                        {% if product.brand %}
                        <span class="brand-tag">{{ product.brand.name }}</span>
                        {% endif %}
                    </div>
                    <div class="product-price">{{product.price|intcomma }}₫</div>
                </div>
            </div>
            {% empty %}
            <div class="col-12">
                <p>Hiện chưa có sản phẩm mới</p>
            </div>
            {% endfor %}
        </div>
    </div>

<!------------------------------ Best Selling Products Slider ------------------------------>
<div class="best-selling-product">
    <h2 class="title">Sản phẩm bán chạy</h2>
    <div class="product-slider-container">
    <!-- Navigation arrows (optional) -->
        <button class="slider-nav prev">‹</button>
        <button class="slider-nav next">›</button>
        
        <div class="product-slider-wrapper">
            {% for product in best_selling_products %}
            <div class="slider-item">
                <div class="best-product-card">
                    <a href="{% url 'product_detail' product.id %}">
                        <img src="{{ product.image.url }}" alt="{{ product.name }}" class="best-product-image">
                        
                        <div class="best-product-info">
                            <h4 class="best-product-name">{{ product.name }}</h4>
                            <div class="best-product-rating">
                                <div class="stars">
                                    {% for i in "12345" %}
                                    <span class="star filled">★</span>
                                    {% endfor %}
                                </div>
                                <span class="rating-count">({{ product.five_star_count }} đánh giá)</span>
                            </div>
                            <div class="price-sales">
                                <div class="best-product-price">{{ product.price|intcomma }}₫</div>
                                <div class="sales-badge">Đã bán: {{ product.total_sold }}</div>
                            </div>
                        </div>
                    </a>
                </div>
                        
                        <!-- Hiển thị đánh giá 5 sao gần nhất -->
                        {% for review_id, review_info in product_reviews.items %}
                            {% if review_id == product.id and review_info.user_name %}
                            <div class="latest-review">
                                <div class="reviewer-info">
                                    <img src="{{ review_info.user_avatar|default:'/static/images/default-avatar.png' }}" 
                                        alt="{{ review_info.user_name }}" class="reviewer-avatar">
                                    <span class="reviewer-name">{{ review_info.user_name }}</span>
                                </div>
                                <div class="review-comment">
                                    "{{ review_info.comment|truncatewords:12 }}"
                                </div>
                            </div>
                            {% endif %}
                        {% endfor %}
            </div>
            {% endfor %}
        </div>
        
        <!-- Indicators (optional) -->
        <div class="slider-indicators">
            {% for product in best_selling_products %}
            <div class="indicator {% if forloop.first %}active{% endif %}"></div>
            {% endfor %}
        </div>
    </div>
</div>

{% endblock %}
{% block extra_js %}<script src="{% static 'js/templatemo-3d-coverflow-scripts.js' %}"></script>{% endblock %}